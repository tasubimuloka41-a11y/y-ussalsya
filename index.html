
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–î—É—Ä–∞–∫ ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π (36 –∫–∞—Ä—Ç, –ø–æ–¥–∫–∏–¥–Ω–æ–π)</title>
<style>
  :root{
    --bg:#0d0f12; --panel:#151922; --text:#eaeef7; --gold:#d6a542;
    --soft:#1a1f29; --accent:#4c79ff; --shadow:rgba(0,0,0,.35);
    --cardW:92px; --cardH:132px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #222}
  h1{margin:0;color:var(--gold);font-weight:700;letter-spacing:.3px}
  main{padding:16px;display:grid;gap:12px}
  .row{display:grid;grid-template-columns:1fr 340px;gap:12px}
  .panel{background:var(--panel);border-radius:12px;border:1px solid rgba(214,165,66,.25);padding:12px}

  /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Å—Ç–∞—Ç—É—Å */
  #status{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
  .badge{padding:6px 10px;border:1px solid rgba(214,165,66,.35);border-radius:10px;color:var(--gold)}
  .small{opacity:.85;font-size:12px}

  /* –ê–≤–∞—Ç–∞—Ä—ã/—Å—á—ë—Ç—á–∏–∫–∏ */
  .players{display:flex;gap:12px;align-items:center;margin-bottom:8px}
  .avatar{display:flex;align-items:center;gap:8px;background:var(--soft);padding:6px 10px;border-radius:10px;border:1px solid rgba(214,165,66,.25)}
  .avatar .icon{font-size:20px}
  .avatar .name{font-weight:600;color:var(--gold)}
  .avatar .count{font-size:12px;opacity:.85}

  /* –ö–æ–ª–æ–¥–∞/–∫–æ–∑—ã—Ä—å –∏ –∫–Ω–æ–ø–∫–∏ */
  .topbar{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  #deck{width:var(--cardW);height:var(--cardH);border-radius:8px;
    background:linear-gradient(135deg,#12151d,#2b2f3a);
    box-shadow:0 10px 20px var(--shadow); border:1px solid rgba(214,165,66,.35); position:relative}
  #trumpCard{position:absolute;right:-14px;bottom:-14px;width:56px;height:80px;border-radius:6px;background:#fafafa;border:1px solid #ccc;
    box-shadow:0 6px 14px rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;font-weight:700}
  #controls{display:flex;gap:8px;flex-wrap:wrap}
  button{background:linear-gradient(135deg,#2b2f3a,#1a1f29);color:var(--gold);
    border:1px solid rgba(214,165,66,.35);border-radius:10px;padding:8px 12px;cursor:pointer}
  button:disabled{opacity:.4;cursor:not-allowed}
  #end{font-weight:700;color:var(--gold);margin-top:6px}

  /* –ü–æ–ª—è */
  #board{display:flex;flex-wrap:wrap;gap:10px;min-height:160px;padding:12px;background:var(--soft);
    border-radius:12px;border:1px solid rgba(214,165,66,.2)}
  #hand,#botHand{display:flex;flex-wrap:wrap;gap:10px;min-height:160px;padding:12px;background:var(--soft);
    border-radius:12px;border:1px solid rgba(214,165,66,.2)}
  #botHand .card{filter:grayscale(.8) opacity(.9)}

  /* –ö–∞—Ä—Ç—ã */
  .stack{position:relative;width:calc(var(--cardW) + 20px);height:calc(var(--cardH) + 20px)}
  .stack .card{position:absolute;left:10px;top:10px}
  .card{
    position:relative;width:var(--cardW);height:var(--cardH);
    background:#fafafa;border-radius:8px;border:1px solid #ccc;
    box-shadow:0 12px 24px var(--shadow);
    transition:transform .22s ease, box-shadow .22s ease, opacity .22s ease; user-select:none;
  }
  .card:hover{transform:translateY(-4px); box-shadow:0 18px 30px rgba(0,0,0,.5)}
  .card.red{color:#cc2a2a} .card.black{color:#111}
  .pip{position:absolute}
  .rankTop{left:8px;top:6px;font-weight:700}
  .suitTop{left:10px;top:28px;font-size:14px}
  .center{left:50%;top:50%;transform:translate(-50%,-50%);font-size:28px;opacity:.85}
  .rankBot{right:8px;bottom:28px;font-weight:700}
  .suitBot{right:10px;bottom:6px;font-size:14px}
  .disabled{opacity:.35;pointer-events:none}
  .selectable{outline:2px dashed rgba(214,165,66,.5)}
  .dealing{opacity:0; transform:scale(.95)}

  /* –õ–æ–≥ */
  #log{max-height:240px;overflow:auto;font-size:13px}
  @media (max-width:900px){ .row{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <h1>–î—É—Ä–∞–∫ ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π</h1>
  <div><button id="newGame">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button></div>
</header>

<main class="row">
  <section class="panel">
    <div class="players">
      <div class="avatar"><span class="icon">üë§</span><span class="name">–í—ã</span><span id="youCount" class="count">0 –∫–∞—Ä—Ç</span></div>
      <div class="avatar"><span class="icon">ü§ñ</span><span class="name">–ë–æ—Ç</span><span id="botCount" class="count">0 –∫–∞—Ä—Ç</span></div>
    </div>

    <div id="status">
      <span id="turn"  class="badge">–•–æ–¥: ‚Äî</span>
      <span id="phase" class="badge small">–§–∞–∑–∞: ‚Äî</span>
      <span id="talon" class="badge">–¢–∞–ª–æ–Ω: 36</span>
    </div>

    <div class="topbar">
      <div id="deck" title="–ö–æ–ª–æ–¥–∞/—Ç–∞–ª–æ–Ω"><div id="trumpCard">‚Äî</div></div>
      <div id="controls">
        <button id="btnPass" disabled>–û—Ç–±–∏—Ç—å—Å—è</button>
        <button id="btnTake" disabled>–í–∑—è—Ç—å</button>
      </div>
    </div>

    <h3 style="margin:8px 0">–°—Ç–æ–ª</h3>
    <div id="board"></div>

    <h3 style="margin:12px 0">–í–∞—à–∞ —Ä—É–∫–∞</h3>
    <div id="hand"></div>

    <h3 style="margin:12px 0">–†—É–∫–∞ –±–æ—Ç–∞</h3>
    <div id="botHand"></div>

    <div id="end"></div>
  </section>

  <aside class="panel">
    <h3>–õ–æ–≥</h3>
    <div id="log"></div>
  </aside>
</main>

<script>
/* =============== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ —É—Ç–∏–ª–∏—Ç—ã =============== */
const RANKS = ['6','7','8','9','10','J','Q','K','A'];
const SUITS = ['S','H','D','C']; // S‚ô† H‚ô• D‚ô¶ C‚ô£
const sym  = s => ({S:'‚ô†',H:'‚ô•',D:'‚ô¶',C:'‚ô£'})[s];
const colorClass = s => (s==='H'||s==='D') ? 'red' : 'black';
const rIndex = r => RANKS.indexOf(r);
function buildDeck(){ const d=[]; for(const s of SUITS) for(const r of RANKS) d.push({r,s,id:`${r}${s}`}); return d; }
function shuffle(a){ for(let i=a.length-1;i>0;i++){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function beats(att, def, trump){
  if(!def) return false;
  if(def.s===att.s && rIndex(def.r)>rIndex(att.r)) return true;
  if(def.s===trump && att.s!==trump) return true;
  return false;
}
function log(msg){ const p=document.createElement('div'); p.textContent=msg; ui.log.appendChild(p); ui.log.scrollTop=ui.log.scrollHeight; }
function clone(o){ return JSON.parse(JSON.stringify(o)); }

/* =============== UI —Å—Å—ã–ª–∫–∏ =============== */
const ui = {
  newGame  : document.querySelector('#newGame'),
  turn     : document.querySelector('#turn'),
  phase    : document.querySelector('#phase'),
  talon    : document.querySelector('#talon'),
  end      : document.querySelector('#end'),
  youCount : document.querySelector('#youCount'),
  botCount : document.querySelector('#botCount'),
  deck     : document.querySelector('#deck'),
  trumpCard: document.querySelector('#trumpCard'),
  board    : document.querySelector('#board'),
  hand     : document.querySelector('#hand'),
  botHand  : document.querySelector('#botHand'),
  log      : document.querySelector('#log'),
  btnPass  : document.querySelector('#btnPass'),
  btnTake  : document.querySelector('#btnTake'),
};
let G = null; // –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

/* =============== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã =============== */
function initGame(){
  const deck = shuffle(buildDeck());
  const trumpCard = deck[deck.length-1]; // –Ω–∏–∂–Ω—è—è –∫–∞—Ä—Ç–∞ —Ç–∞–ª–æ–Ω–∞ ‚Äî –∫–æ–∑—ã—Ä–Ω–∞—è –º–∞—Å—Ç—å
  const trump = trumpCard.s;

  const you = deck.splice(0,6);
  const bot = deck.splice(0,6);

  // –ø–µ—Ä–≤—ã–π —Ö–æ–¥ ‚Äî –≤–ª–∞–¥–µ–ª–µ—Ü –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–∑—ã—Ä—è
  const minT = hand => hand.filter(c=>c.s===trump).sort((a,b)=>rIndex(a.r)-rIndex(b.r))[0] || {r:'A'};
  const attacker = (rIndex(minT(you).r) < rIndex(minT(bot).r)) ? 'you' : 'bot';

  G = {
    trump, deck, trumpCard, discard: [],
    hands: { you, bot },
    attacker, defender: attacker==='you'?'bot':'you',
    phase: 'attack', // 'attack'|'defense'
    table: [], // [{attack, defense}]
    finished:false
  };

  ui.end.textContent = '';
  ui.board.innerHTML = '';
  ui.log.innerHTML = '';
  renderHands(); renderBotHand(); renderTable();
  updateHeader();
  dealAnimation('you');
  ui.trumpCard.textContent = sym(G.trump);

  if(G.attacker==='bot') setTimeout(botAttackStart, 600);
}

/* =============== –†–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç =============== */
function cardEl(card){
  const el = document.createElement('div');
  el.className = `card ${colorClass(card.s)}`;
  el.dataset.id = card.id;
  el.innerHTML = `
    <div class="pip rankTop">${card.r}</div>
    <div class="pip suitTop">${sym(card.s)}</div>
    <div class="pip center">${sym(card.s)}</div>
    <div class="pip rankBot">${card.r}</div>
    <div class="pip suitBot">${sym(card.s)}</div>
  `;
  return el;
}
function renderHands(){
  ui.hand.innerHTML = '';
  G.hands.you.forEach(c=>{
    const el = cardEl(c);
    el.onclick = ()=>onCardClick(c);
    ui.hand.appendChild(el);
  });
  ui.youCount.textContent = `${G.hands.you.length} –∫–∞—Ä—Ç`;
}
function renderBotHand(){
  ui.botHand.innerHTML = '';
  G.hands.bot.forEach(c=>{
    const el = cardEl(c);
    el.classList.add('disabled');
    ui.botHand.appendChild(el);
  });
  ui.botCount.textContent = `${G.hands.bot.length} –∫–∞—Ä—Ç`;
}
function renderTable(){
  ui.board.innerHTML = '';
  G.table.forEach(pair=>{
    const st = document.createElement('div'); st.className='stack';
    st.appendChild(cardEl(pair.attack));
    if(pair.defense) st.appendChild(cardEl(pair.defense));
    ui.board.appendChild(st);
  });
}
function updateHeader(){
  ui.turn.textContent  = `–•–æ–¥: ${G.attacker==='you'?'–í—ã':'–ë–æ—Ç'}`;
  ui.phase.textContent = `–§–∞–∑–∞: ${G.phase==='attack'?'–ê—Ç–∞–∫–∞/–ø–æ–¥–∫–∏–¥':'–ó–∞—â–∏—Ç–∞'}`;
  ui.talon.textContent = `–¢–∞–ª–æ–Ω: ${G.deck.length}`;
  ui.btnTake.disabled = !(G.phase==='defense' && G.defender==='you' && G.table.some(p=>!p.defense));
  ui.btnPass.disabled = !(G.phase==='defense' && G.defender==='you' && G.table.length>0 && G.table.every(p=>p.defense));
}

/* =============== –ê–Ω–∏–º–∞—Ü–∏–∏ (–±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫) =============== */
function dealAnimation(who){
  const deckBox = ui.deck.getBoundingClientRect();
  const list = who==='you' ? Array.from(ui.hand.querySelectorAll('.card'))
                           : Array.from(ui.botHand.querySelectorAll('.card'));
  list.forEach(el=>el.classList.add('dealing'));
  list.forEach((el,i)=>{
    const box = el.getBoundingClientRect();
    const dx = (deckBox.left + deckBox.width/2) - (box.left + box.width/2);
    const dy = (deckBox.top  + deckBox.height/2) - (box.top  + box.height/2);
    el.style.transition = 'transform .45s ease, opacity .45s ease';
    requestAnimationFrame(()=>{
      el.style.transform = `translate(${dx}px,${dy}px) scale(.95)`;
      el.style.opacity = '0';
      setTimeout(()=>{
        el.style.transform = 'translate(0,0) scale(1)';
        el.style.opacity = '1';
        setTimeout(()=>el.classList.remove('dealing'), 200);
      }, 30 + i*120);
    });
  });
}
function flyFromHandToBoard(card){
  const src = ui.hand.querySelector(`[data-id="${card.id}"]`);
  if(!src) return;
  const ghost = src.cloneNode(true);
  document.body.appendChild(ghost);
  const from = src.getBoundingClientRect();
  const to = ui.board.getBoundingClientRect();
  Object.assign(ghost.style,{position:'fixed',left:`${from.left}px`,top:`${from.top}px`,zIndex:'999',transition:'transform .35s ease'});
  const tx = (to.left + 20 + Math.random()*20) - from.left;
  const ty = (to.top  + 20 + Math.random()*15) - from.top;
  requestAnimationFrame(()=>{ ghost.style.transform = `translate(${tx}px,${ty}px) rotate(${(Math.random()*10-5)}deg)`; });
  setTimeout(()=>ghost.remove(),380);
}
function discardAnimation(){
  const els = Array.from(ui.board.querySelectorAll('.card'));
  els.forEach((el,i)=>{
    const b = el.getBoundingClientRect();
    const dx = (ui.deck.getBoundingClientRect().left - b.left);
    const dy = (ui.deck.getBoundingClientRect().top  - b.top );
    el.style.transition = 'transform .35s ease, opacity .35s ease';
    el.style.transform = `translate(${dx}px,${dy}px) rotate(${(Math.random()*20 - 10)}deg) scale(.9)`;
    el.style.opacity = '0';
    setTimeout(()=>el.remove(), 360+i*30);
  });
}

/* =============== –ö–ª–∏–∫–∏ –ø–æ –∫–∞—Ä—Ç–∞–º (–∏–≥—Ä–æ–∫) =============== */
function onCardClick(card){
  if(G.finished) return;
  const ranksOnTable = new Set();
  G.table.forEach(p=>{ ranksOnTable.add(p.attack.r); if(p.defense) ranksOnTable.add(p.defense.r); });

  if(G.attacker==='you' && G.phase==='attack'){
    // –ø–µ—Ä–≤–∞—è –∞—Ç–∞–∫–∞: –ª—é–±–∞—è –∫–∞—Ä—Ç–∞, –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ —Ä–∞–Ω–≥—É, –Ω–µ –ø—Ä–µ–≤—ã—à–∞—è —Ä–∞–∑–º–µ—Ä —Ä—É–∫–∏ –∑–∞—â–∏—Ç–Ω–∏–∫–∞
    const canThrowMore = G.table.length < G.hands[G.defender].length;
    const isFirst = G.table.length===0;
    const ok = isFirst || (canThrowMore && ranksOnTable.has(card.r));
    if(!ok) return;
    playAttack('you', card, !isFirst);
    G.phase='defense'; updateHeader();
    setTimeout(botDefendStep, 600);
  }
  else if(G.defender==='you' && G.phase==='defense'){
    // –∑–∞—â–∏—â–∞–µ–º –ø–µ—Ä–≤—É—é –Ω–µ–ø–æ–∫—Ä—ã—Ç—É—é
    const idx = G.table.findIndex(p=>!p.defense);
    if(idx<0) return;
    const att = G.table[idx].attack;
    const ok = beats(att, card, G.trump);
    if(!ok) return;
    playDefense('you', card);
    // –µ—Å–ª–∏ –≤—Å–µ –ø–æ–∫—Ä—ã—Ç—ã ‚Äî –±–æ—Ç –º–æ–∂–µ—Ç –ø–æ–¥–∫–∏–Ω—É—Ç—å
    if(G.table.every(p=>p.defense)){
      if(canThrow('bot') && G.table.length < G.hands.you.length){
        setTimeout(botThrowLoop, 500);
      } else {
        updateHeader(); // –≤–∫–ª—é—á–∏—Ç—Å—è "–û—Ç–±–∏—Ç—å—Å—è"
      }
    } else {
      setTimeout(botDefendStep, 400);
    }
  }
}

/* =============== –î–µ–π—Å—Ç–≤–∏—è –∏–≥—Ä–æ–∫–∞: –û—Ç–±–∏—Ç—å—Å—è / –í–∑—è—Ç—å =============== */
ui.btnPass.onclick = ()=>{
  if(!(G.phase==='defense' && G.defender==='you' && G.table.length>0 && G.table.every(p=>p.defense))) return;
  // –µ—Å–ª–∏ –±–æ—Ç –º–æ–∂–µ—Ç –µ—â—ë –ø–æ–¥–∫–∏–Ω—É—Ç—å ‚Äî –æ–Ω —Å–¥–µ–ª–∞–µ—Ç —ç—Ç–æ, –∏–Ω–∞—á–µ –æ—Ç–±–æ–π
  if(canThrow('bot') && G.table.length < G.hands.you.length){
    botThrowLoop(()=>endBout(true));
  } else {
    endBout(true);
  }
};
ui.btnTake.onclick = ()=>{
  if(!(G.phase==='defense' && G.defender==='you')) return;
  defenderTake('you');
};

/* =============== –•–æ–¥—ã: –∞—Ç–∞–∫–∞/–∑–∞—â–∏—Ç–∞/–ø–æ–¥–∫–∏–¥—ã–≤–∞–Ω–∏–µ =============== */
function playAttack(who, card, isThrow=false){
  removeFromHand(who, card);
  if(who==='you') flyFromHandToBoard(card);

  G.table.push({attack:card, defense:null});
  renderHands(); renderBotHand(); renderTable();
  log(`${who==='you'?'–í—ã':'–ë–æ—Ç'} ${isThrow?'–ø–æ–¥–∫–∏–¥—ã–≤–∞–µ—Ç':'–∞—Ç–∞–∫—É–µ—Ç'}: ${card.r}${sym(card.s)}`);
}
function playDefense(who, card){
  const idx = G.table.findIndex(p=>!p.defense);
  if(idx<0) return;
  const att = G.table[idx].attack;
  const ok = beats(att,card,G.trump);
  if(!ok) return;

  removeFromHand(who, card);
  if(who==='you') flyFromHandToBoard(card);

  G.table[idx].defense = card;
  renderHands(); renderBotHand(); renderTable();
  log(`${who==='you'?'–í—ã':'–ë–æ—Ç'} –∑–∞—â–∏—Ç–∏–ª—Å—è: ${card.r}${sym(card.s)} –ø—Ä–æ—Ç–∏–≤ ${att.r}${sym(att.s)}`);
  updateHeader();
}

/* =============== –ë–æ—Ç: –ª–æ–≥–∏–∫–∞ =============== */
function botAttackStart(){
  if(G.finished) return;
  // –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –Ω–µ-–∫–æ–∑—ã—Ä–Ω–∞—è, –∑–∞—Ç–µ–º –∫–æ–∑—ã—Ä—å
  const hand = clone(G.hands.bot).sort((a,b)=>{
    const ta = a.s===G.trump, tb = b.s===G.trump;
    if(ta!==tb) return ta?1:-1;
    return rIndex(a.r)-rIndex(b.r);
  });
  const card = hand[0];
  playAttack('bot', card, false);
  G.phase='defense'; updateHeader();
}
function botDefendStep(){
  if(G.finished) return;
  const idx = G.table.findIndex(p=>!p.defense);
  if(idx<0) return;
  const att = G.table[idx].attack;

  // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–æ–∫—Ä—ã–≤–∞—é—â–∞—è –∫–∞—Ä—Ç–∞
  const options = G.hands.bot.filter(c=>beats(att,c,G.trump))
    .sort((a,b)=>{ const ta=a.s===G.trump, tb=b.s===G.trump; if(ta!==tb) return ta?1:-1; return rIndex(a.r)-rIndex(b.r); });

  if(options.length){
    playDefense('bot', options[0]);
    if(G.table.every(p=>p.defense)){
      // —á–µ–ª–æ–≤–µ–∫ –º–æ–∂–µ—Ç –ø–æ–¥–∫–∏–Ω—É—Ç—å
      updateHeader(); // –≤–∫–ª—é—á–∞–µ—Ç ¬´–û—Ç–±–∏—Ç—å—Å—è¬ª
    } else {
      setTimeout(botDefendStep, 400);
    }
  } else {
    defenderTake('bot');
  }
}
function canThrow(who){
  if(G.table.length===0) return false;
  const ranks = new Set();
  G.table.forEach(p=>{ ranks.add(p.attack.r); if(p.defense) ranks.add(p.defense.r); });
  const hand = G.hands[who];
  return hand.some(c=>ranks.has(c.r));
}
function botThrowLoop(done){
  const ranks = new Set(); G.table.forEach(p=>{ ranks.add(p.attack.r); if(p.defense) ranks.add(p.defense.r); });
  while(G.table.length < G.hands[G.defender].length){
    const candidates = G.hands.bot.filter(c=>ranks.has(c.r)).sort((a,b)=>rIndex(a.r)-rIndex(b.r));
    if(!candidates.length) break;
    const card = candidates[0];
    playAttack('bot', card, true);
    // –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–Ω–≥–∏ –Ω–∞ —Å—Ç–æ–ª–µ
    ranks.add(card.r);
    // –¥–∞—ë–º –∑–∞—â–∏—Ç–Ω–∏–∫—É —à–∞–Ω—Å –∑–∞–∫—Ä—ã—Ç—å (–µ—Å–ª–∏ –∑–∞—â–∏—Ç–Ω–∏–∫ ‚Äî –±–æ—Ç, –æ–Ω –∑–∞–∫—Ä–æ–µ—Ç —Å–∞–º; –µ—Å–ª–∏ –∑–∞—â–∏—Ç–Ω–∏–∫ ‚Äî —á–µ–ª–æ–≤–µ–∫, –∂–¥—ë–º –∫–ª–∏–∫–æ–≤)
    if(G.defender==='bot'){ setTimeout(botDefendStep, 500); return; }
    else { updateHeader(); return; }
  }
  done && done();
}

/* =============== –ó–∞—â–∏—Ç–Ω–∏–∫ –±–µ—Ä—ë—Ç =============== */
function defenderTake(who){
  const takeCards = [];
  G.table.forEach(p=>{ if(p.attack) takeCards.push(p.attack); if(p.defense) takeCards.push(p.defense); });
  takeCards.forEach(c=>G.hands[who].push(c));
  log(`${who==='you'?'–í—ã':'–ë–æ—Ç'} –≤–∑—è–ª ${takeCards.length} –∫–∞—Ä—Ç(—ã).`);
  G.table = []; ui.board.innerHTML = '';
  renderHands(); renderBotHand();

  // –¥–æ–±–æ—Ä –¥–æ 6: —Å–Ω–∞—á–∞–ª–∞ –∞—Ç–∞–∫—É—é—â–∏–π, –∑–∞—Ç–µ–º –≤–∑—è–≤—à–∏–π
  refillOrder([G.attacker, who]);

  // –∞—Ç–∞–∫—É—é—â–∏–º –æ—Å—Ç–∞—ë—Ç—Å—è —Ç–æ—Ç –∂–µ –∏–≥—Ä–æ–∫
  G.defender = (G.attacker==='you')?'bot':'you';
  G.phase='attack'; updateHeader();
  checkEnd();

  if(!G.finished){
    if(G.attacker==='bot') setTimeout(botAttackStart, 600);
  }
}

/* =============== –û—Ç–±–æ–π –∏ –¥–æ–±–æ—Ä =============== */
function endBout(defenseSucceeded){
  discardAnimation();
  G.table.forEach(p=>{ if(p.attack) G.discard.push(p.attack); if(p.defense) G.discard.push(p.defense); });
  G.table = [];

  // –¥–æ–±–æ—Ä –¥–æ 6: —Å–Ω–∞—á–∞–ª–∞ –∞—Ç–∞–∫—É—é—â–∏–π, –∑–∞—Ç–µ–º –∑–∞—â–∏—Ç–∏–≤—à–∏–π—Å—è
  refillOrder([G.attacker, G.defender]);

  if(defenseSucceeded){
    const next = G.defender;
    G.attacker = next;
    G.defender = (next==='you')?'bot':'you';
    log(`–û—Ç–±–æ–π. –ê—Ç–∞–∫—É–µ—Ç: ${G.attacker==='you'?'–í—ã':'–ë–æ—Ç'}.`);
  }

  G.phase='attack'; updateHeader();
  checkEnd();

  if(!G.finished){
    if(G.attacker==='bot') setTimeout(botAttackStart, 600);
  }
}
function refillOrder(order){
  for(const who of order){
    while(G.hands[who].length<6 && G.deck.length){
      const c = G.deck.shift();
      G.hands[who].push(c);
      if(who==='you'){
        const el = cardEl(c); el.classList.add('dealing'); ui.hand.appendChild(el);
        const deckBox = ui.deck.getBoundingClientRect();
        const box = el.getBoundingClientRect();
        const dx = (deckBox.left + deckBox.width/2) - (box.left + box.width/2);
        const dy = (deckBox.top  + deckBox.height/2) - (box.top  + box.height/2);
        el.style.transition = 'transform .35s ease, opacity .35s ease';
        requestAnimationFrame(()=>{
          el.style.transform = `translate(${dx}px,${dy}px) scale(.95)`; el.style.opacity = '0';
          setTimeout(()=>{
            el.style.transform = 'translate(0,0) scale(1)'; el.style.opacity = '1';
            setTimeout(()=>el.classList.remove('dealing'), 150);
            el.onclick = ()=>onCardClick(c);
          }, 20);
        });
      }
    }
  }
  updateHeader();
}

/* =============== –ü–æ–º–æ—â–Ω–∏–∫–∏ —Ä—É–∫ =============== */
function removeFromHand(who, card){
  const i = G.hands[who].findIndex(c=>c.id===card.id);
  if(i>=0) G.hands[who].splice(i,1);
  if(who==='you'){
    const el = ui.hand.querySelector(`[data-id="${card.id}"]`); if(el) el.remove();
  } else {
    const el = ui.botHand.querySelector(`[data-id="${card.id}"]`); if(el) el.remove();
  }
  ui.youCount.textContent = `${G.hands.you.length} –∫–∞—Ä—Ç`;
  ui.botCount.textContent = `${G.hands.bot.length} –∫–∞—Ä—Ç`;
}

/* =============== –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–≥—Ä—ã =============== */
function checkEnd(){
  const youEmpty = G.hands.you.length===0;
  const botEmpty = G.hands.bot.length===0;
  if(G.deck.length===0 && (youEmpty || botEmpty)){
    G.finished = true;
    if(youEmpty && !botEmpty) ui.end.textContent = '–ü–æ–±–µ–¥–∞! –í—ã –≤—ã—à–ª–∏ –∏–∑ –∫–∞—Ä—Ç.';
    else if(botEmpty && !youEmpty) ui.end.textContent = '–ü–æ—Ä–∞–∂–µ–Ω–∏–µ: –±–æ—Ç –≤—ã—à–µ–ª –∏–∑ –∫–∞—Ä—Ç.';
    else ui.end.textContent = '–ù–∏—á—å—è (–æ–±–∞ –≤—ã—à–ª–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ).';
    ui.btnPass.disabled = ui.btnTake.disabled = true;
  }
}

/* =============== –°–æ–±—ã—Ç–∏—è =============== */
ui.newGame.onclick = initGame;
initGame();
</script>
</body>
</html>
``
