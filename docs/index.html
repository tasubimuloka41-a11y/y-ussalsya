<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comet - AI Web Agent</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; min-height: 100vh; padding: 20px; }
    .container { max-width: 900px; margin: 0 auto; }
    h1 { text-align: center; margin-bottom: 20px; font-size: 28px; }
    #app { display: flex; flex-direction: column; height: 600px; background: rgba(0,0,0,0.1); border-radius: 15px; overflow: hidden; backdrop-filter: blur(10px); }
    #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
    .msg-wrap { display: flex; margin: 5px 0; }
    .msg-user { justify-content: flex-end; }
    .msg-ai { justify-content: flex-start; }
    .msg { max-width: 80%; padding: 12px 15px; border-radius: 15px; word-wrap: break-word; line-height: 1.5; }
    .msg-user .msg { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); }
    .msg-ai .msg { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); }
    .msg img { max-width: 100%; height: auto; border-radius: 10px; margin-top: 8px; }
    #controls { display: flex; gap: 8px; padding: 15px; background: rgba(0,0,0,0.2); border-top: 1px solid rgba(255,255,255,0.2); flex-wrap: wrap; }
    button { padding: 10px 15px; background: rgba(255,255,255,0.2); color: #fff; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: 0.2s; }
    button:hover { background: rgba(255,255,255,0.3); }
    button.active { background: rgba(255,255,255,0.4); box-shadow: 0 0 15px rgba(255,255,255,0.3); }
    #input { flex: 1; min-width: 150px; padding: 10px 15px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: #fff; border-radius: 8px; font-size: 13px; }
    #input::placeholder { color: rgba(255,255,255,0.6); }
    #input:focus { outline: none; background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.5); }
    #file-input { display: none; }
    .footer { text-align: center; margin-top: 20px; font-size: 12px; opacity: 0.8; }
  </style>
</head>
<body>
  <div class="container">
    <h1>✨ Comet - AI Web Agent</h1>
    <div id="app">
      <div id="messages"></div>
      <div id="controls">
        <button id="fileBtn">📁 Файлы</button>
        <button id="analyzeBtn">👁️ Анализ</button>
        <button id="autoBtn">🤖 Авто</button>
        <input type="text" id="input" placeholder="Команда...">
        <button id="sendBtn">➤ Отправить</button>
        <input type="file" id="file-input" multiple accept="image/*">
      </div>
    </div>
    <div class="footer">
      🚀 Ollama: http://127.0.0.1:11435<br>
      Запусти: ollama serve
    </div>
  </div>
  <script>
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');
    const messages = document.getElementById('messages');
    const fileBtn = document.getElementById('fileBtn');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const autoBtn = document.getElementById('autoBtn');
    const fileInput = document.getElementById('file-input');

    let selectedFiles = [];
    let autoMode = false;
    let currentImage = null;

    fileBtn.addEventListener('click', () => fileInput.click());
    analyzeBtn.addEventListener('click', () => analyzeImage('Проанализируй'));
    autoBtn.addEventListener('click', () => {
      autoMode = !autoMode;
      autoBtn.classList.toggle('active');
      addMsg(autoMode ? '🤖 Авто' : '❌ Авто', 'ai');
    });
    fileInput.addEventListener('change', (e) => {
      selectedFiles = Array.from(e.target.files);
      addMsg(`📎 ${selectedFiles.length} файл`, 'ai');
    });
    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener('keypress', (e) => e.key === 'Enter' && sendMessage());

    function analyzeImage(prompt) {
      if (!currentImage) { addMsg('❌ Нет картинки', 'ai'); return; }
      sendToAI(prompt, currentImage);
    }

    function sendMessage() {
      const text = input.value.trim();
      if (!text && selectedFiles.length === 0) return;
      if (text) addMsg(text, 'user');
      input.value = '';
      
      if (selectedFiles.length > 0) {
        selectedFiles.forEach((file) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            currentImage = e.target.result;
            const wrap = document.createElement('div');
            wrap.className = 'msg-wrap msg-user';
            const msgDiv = document.createElement('div');
            msgDiv.className = 'msg';
            const img = document.createElement('img');
            img.src = currentImage;
            msgDiv.appendChild(img);
            wrap.appendChild(msgDiv);
            messages.appendChild(wrap);
            sendToAI(text || 'Что?', currentImage);
          };
          reader.readAsDataURL(file);
        });
        selectedFiles = [];
        fileInput.value = '';
      } else {
        sendToAI(text);
      }
    }

    function sendToAI(prompt, image = null) {
      addMsg('⏳ Думаю...', 'ai');
      let body = { model: 'gemma3:12b', prompt: prompt, stream: false, temperature: 0.6 };
      if (image && image.startsWith('data:image')) {
        const base64 = image.split(',')[1];
        body.images = [base64];
      }
      fetch('http://127.0.0.1:11435/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      })
      .then(r => r.json())
      .then(d => {
        const lastMsg = messages.lastChild;
        if (lastMsg?.querySelector('.msg')?.textContent === '⏳ Думаю...') lastMsg.remove();
        addMsg(d.response || 'Нет ответа', 'ai');
      })
      .catch(e => addMsg('❌ ' + e.message, 'ai'));
    }

    function addMsg(text, sender) {
      const wrap = document.createElement('div');
      wrap.className = 'msg-wrap msg-' + sender;
      const msgDiv = document.createElement('div');
      msgDiv.className = 'msg';
      msgDiv.textContent = text;
      wrap.appendChild(msgDiv);
      messages.appendChild(wrap);
      messages.scrollTop = messages.scrollHeight;
    }

    addMsg('✨ Comet готов!', 'ai');
  </script>
</body>
</html>
